@page "/collections/create"
@rendermode InteractiveServer
@attribute [Authorize]
@using _10xCards.Application.Services
@using Microsoft.AspNetCore.Authorization

<PageTitle>Create Collection - 10xCards</PageTitle>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="mb-4">Create New Collection</h2>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @errorMessage
                    <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)" aria-label="Close"></button>
                </div>
            }

            <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="name" class="form-label">Collection Name *</label>
                    <InputText id="name" 
                               @bind-Value="model.Name" 
                               class="form-control" 
                               placeholder="e.g., Biology Exam Prep" 
                               disabled="@isSubmitting" />
                    <ValidationMessage For="@(() => model.Name)" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <InputTextArea id="description" 
                                   @bind-Value="model.Description" 
                                   class="form-control" 
                                   rows="3"
                                   placeholder="Optional description for this collection..." 
                                   disabled="@isSubmitting" />
                    <ValidationMessage For="@(() => model.Description)" class="text-danger" />
                </div>

                <div class="mb-4">
                    <label class="form-label">Select Flashcards *</label>
                    
                    @if (isLoadingCards)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading cards...</span>
                            </div>
                            <span class="ms-2">Loading your flashcards...</span>
                        </div>
                    }
                    else if (availableCards == null || !availableCards.Any())
                    {
                        <div class="alert alert-info">
                            <p class="mb-0">You don't have any flashcards yet. <a href="/cards/create">Create some first!</a></p>
                        </div>
                    }
                    else
                    {
                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                            <div class="mb-2">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary me-2" 
                                        @onclick="SelectAll"
                                        disabled="@isSubmitting">
                                    Select All
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-outline-secondary" 
                                        @onclick="DeselectAll"
                                        disabled="@isSubmitting">
                                    Deselect All
                                </button>
                                <span class="ms-3 text-muted">Selected: @selectedCardIds.Count</span>
                            </div>

                            @foreach (var card in availableCards)
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="card-@card.Id" 
                                           checked="@selectedCardIds.Contains(card.Id)"
                                           @onclick="@(() => ToggleCard(card.Id))"
                                           disabled="@isSubmitting" />
                                    <label class="form-check-label" for="card-@card.Id">
                                        <strong>@card.FrontPreview</strong>
                                    </label>
                                </div>
                            }
                        </div>
                        
                        @if (selectedCardIds.Count == 0)
                        {
                            <div class="text-danger mt-2">
                                <small>Please select at least one flashcard.</small>
                            </div>
                        }
                    }
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" 
                            class="btn btn-primary" 
                            disabled="@(isSubmitting || selectedCardIds.Count == 0)">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Creating...</span>
                        }
                        else
                        {
                            <span><i class="bi bi-check-circle"></i> Create Collection</span>
                        }
                    </button>
                    <a href="/collections" class="btn btn-outline-secondary" disabled="@isSubmitting">
                        Cancel
                    </a>
                </div>
            </EditForm>
        </div>
    </div>
</div>
